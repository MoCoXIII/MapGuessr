const gameModes = {
    "Portal Series": {
        "Portal 2": {
            "Chapter 1 - The Courtesy Call": {
                "Container Ride": {
                    "Intact Room": [
                        "images/portal2/chapter1/container_ride/maps/intact_room.png",
                        ["images/portal2/chapter1/container_ride/0.png", [0.45588235294117646, 0.4911297852474323]],
                    ],
                    "Broken Room": [
                        "images/portal2/chapter1/container_ride/maps/broken_room.png",
                        ["images/portal2/chapter1/container_ride/1.png", [0.2668067226890756, 0.7002801120448179]],
                        ["images/portal2/chapter1/container_ride/2.png", [0.6418067226890757, 0.7413632119514473]],
                        ["images/portal2/chapter1/container_ride/3.png", [0.6502100840336135, 0.34173669467787116]],
                    ],
                    "Container Ride": [
                        "images/portal2/chapter1/container_ride/maps/container_ride.png",
                        ["images/portal2/chapter1/container_ride/4.png", [0.43487394957983194, 0.6909430438842203]],
                        ["images/portal2/chapter1/container_ride/5.png", [0.6880252100840336, 0.3137254901960784]],
                    ],
                    "Puzzle": [
                        "images/portal2/chapter1/container_ride/maps/puzzle.png",
                        ["images/portal2/chapter1/container_ride/6.png", [0.8886554621848739, 0.1792717086834734]],
                        ["images/portal2/chapter1/container_ride/7.png", [0.8287815126050421, 0.48552754435107376]],
                        ["images/portal2/chapter1/container_ride/8.png", [0.40861344537815125, 0.6946778711484594]],
                    ],
                },
                "Portal Carousel": [
                    "images/portal2/chapter1/portal_carousel/maps/0.png",
                    ["images/portal2/chapter1/portal_carousel/0.png", [0.43592436974789917, 0.4668534080298786]],
                    ["images/portal2/chapter1/portal_carousel/1.png", [0.7321428571428571, 0.4425770308123249]],
                ],
                "Portal Gun": {
                    "0": [
                        "images/portal2/chapter1/portal_gun/maps/0.png",
                        ["images/portal2/chapter1/portal_gun/0.png", [0.6418067226890757, 0.32492997198879553]],
                        ["images/portal2/chapter1/portal_gun/1.png", [0.42962184873949577, 0.4519140989729225]],
                        ["images/portal2/chapter1/portal_gun/2.png", [0.37289915966386555, 0.6255835667600373]],
                    ],
                    "1": [
                        "images/portal2/chapter1/portal_gun/maps/1.png",
                        ["images/portal2/chapter1/portal_gun/3.png", [0.5945378151260504, 0.491129785247432]],
                        ["images/portal2/chapter1/portal_gun/4.png", [0.5, 0.5322128851540616]],
                    ],
                    "2": [
                        "images/portal2/chapter1/portal_gun/maps/2.png",
                        ["images/portal2/chapter1/portal_gun/5.png", [0.3245798319327731, 0.4126984126984127]],
                    ],
                    "3": [
                        "images/portal2/chapter1/portal_gun/maps/3.png",
                        ["images/portal2/chapter1/portal_gun/6.png", [0.7573529411764706, 0.5863678804855276]],
                        ["images/portal2/chapter1/portal_gun/7.png", [0.47478991596638653, 0.4332399626517274]],
                        ["images/portal2/chapter1/portal_gun/8.png", [0.2815126050420168, 0.6367880485527544]],
                    ],
                },
                "Smooth Jazz": {
                    "0": [
                        "images/portal2/chapter1/smooth_jazz/maps/0.png",
                        ["images/portal2/chapter1/smooth_jazz/0.png", [0.7657563025210085, 0.7563025210084033]],
                        ["images/portal2/chapter1/smooth_jazz/1.png", [0.5367647058823529, 0.5770308123249299]],
                    ],
                    "1": [
                        "images/portal2/chapter1/smooth_jazz/maps/1.png",
                        ["images/portal2/chapter1/smooth_jazz/2.png", [0.4800420168067227, 0.6535947712418301]],
                        ["images/portal2/chapter1/smooth_jazz/3.png", [0.5189075630252101, 0.4556489262371615]],
                    ],
                },
                "Cube Momentum": [
                    "images/portal2/chapter1/cube_momentum/maps/0.png",
                    ["images/portal2/chapter1/cube_momentum/0.png", [0.31092436974789917, 0.5434173669467787]],
                    ["images/portal2/chapter1/cube_momentum/1.png", [0.657563025210084, 0.4388422035480859]],
                    ["images/portal2/chapter1/cube_momentum/2.png", [0.6386554621848739, 0.4369747899159664]],
                ],
                "Future Starter": {
                    "0": [
                        "images/portal2/chapter1/future_starter/maps/0.png",
                        ["images/portal2/chapter1/future_starter/0.png", [0.7027310924369747, 0.6218487394957983]],
                        ["images/portal2/chapter1/future_starter/1.png", [0.4989495798319328, 0.3641456582633053]],
                        ["images/portal2/chapter1/future_starter/2.png", [0.6365546218487395, 0.40896358543417366]],
                    ],
                    "1": [
                        "images/portal2/chapter1/future_starter/maps/1.png",
                        ["images/portal2/chapter1/future_starter/3.png", [0.8581932773109243, 0.32492997198879553]],
                        ["images/portal2/chapter1/future_starter/4.png", [0.4810924369747899, 0.9953314659197012]],
                        ["images/portal2/chapter1/future_starter/5.png", [0.42857142857142855, 0.5490196078431373]],
                    ],
                },
                "Secret Panel": {
                    "0": [
                        "images/portal2/chapter1/secret_panel/maps/0.png",
                        ["images/portal2/chapter1/secret_panel/0.png", [0.12920168067226892, 0.6181139122315593]],
                        ["images/portal2/chapter1/secret_panel/1.png", [0.26785714285714285, 0.6647992530345471]],
                        ["images/portal2/chapter1/secret_panel/3.png", [0.7668067226890757, 0.2446311858076564]],
                        ["images/portal2/chapter1/secret_panel/4.png", [0.8067226890756303, 0.38095238095238093]],
                    ],
                    "1": [
                        "images/portal2/chapter1/secret_panel/maps/1.png",
                        ["images/portal2/chapter1/secret_panel/2.png", [0.5388655462184874, 0.47992530345471524]],
                    ]
                },
                "Wake Up": {
                    "0": [
                        "images/portal2/chapter1/wake_up/maps/0.png",
                        ["images/portal2/chapter1/wake_up/0.png", [0.25315126050420167, 0.6685340802987861]],
                        ["images/portal2/chapter1/wake_up/1.png", [0.6964285714285714, 0.3622782446311858]],
                        ["images/portal2/chapter1/wake_up/2.png", [0.27941176470588236, 0.3510737628384687]],
                        ["images/portal2/chapter1/wake_up/4.png", [0.22794117647058823, 0.23902894491129786]],
                        ["images/portal2/chapter1/wake_up/5.png", [0.5903361344537815, 0.30438842203548083]],
                    ],
                    "1": [
                        "images/portal2/chapter1/wake_up/maps/1.png",
                        ["images/portal2/chapter1/wake_up/3.png", [0.4642857142857143, 0.43137254901960786]],
                    ]
                },
                "Incinerator": {
                    "0": [
                        "images/portal2/chapter1/incinerator/maps/0.png",
                        ["images/portal2/chapter1/incinerator/0.png", [0.5157563025210085, 0.7787114845938375]],
                    ],
                    "1": [
                        "images/portal2/chapter1/incinerator/maps/1.png",
                        ["images/portal2/chapter1/incinerator/1.png", [0.5493697478991597, 0.715219421101774]],

                    ],
                    "2": [
                        "images/portal2/chapter1/incinerator/maps/2.png",
                        ["images/portal2/chapter1/incinerator/2.png", [0.2510504201680672, 0.7133520074696545]],
                        ["images/portal2/chapter1/incinerator/3.png", [0.5882352941176471, 0.6162464985994398]],
                        ["images/portal2/chapter1/incinerator/4.png", [0.5619747899159664, 0.40149393090569563]],
                    ],
                }
            },
            "Chapter 2 - The Cold Boot": {
                "Laser Intro": [
                    "images/portal2/chapter2/laser_intro/maps/0.png",
                    ["images/portal2/chapter2/laser_intro/0.png", [0.41911764705882354, 0.6610644257703081]],
                    ["images/portal2/chapter2/laser_intro/1.png", [0.2867647058823529, 0.26143790849673204]],
                    ["images/portal2/chapter2/laser_intro/2.png", [0.6512605042016807, 0.5508870214752568]],
                ],
                "Laser Stairs": [
                    "images/portal2/chapter2/laser_stairs/maps/0.png",
                    ["images/portal2/chapter2/laser_stairs/0.png", [0.10714285714285714, 0.5452847805788982]],
                    ["images/portal2/chapter2/laser_stairs/1.png", [0.4642857142857143, 0.5004668534080299]],
                    ["images/portal2/chapter2/laser_stairs/2.png", [0.7027310924369747, 0.5583566760037348]],
                    ["images/portal2/chapter2/laser_stairs/3.png", [0.842436974789916, 0.3772175536881419]],
                ],
                "Dual Lasers": {
                    "0": [
                        "images/portal2/chapter2/dual_lasers/maps/0.png",
                        ["images/portal2/chapter2/dual_lasers/1.png", [0.6428571428571429, 0.5098039215686274]],
                        ["images/portal2/chapter2/dual_lasers/2.png", [0.37815126050420167, 0.6218487394957983]],
                    ],
                    "1": [
                        "images/portal2/chapter2/dual_lasers/maps/1.png",
                        ["images/portal2/chapter2/dual_lasers/0.png", [0.23634453781512604, 0.707749766573296]],
                        ["images/portal2/chapter2/dual_lasers/3.png", [0.43592436974789917, 0.6255835667600373]],
                        ["images/portal2/chapter2/dual_lasers/4.png", [0.7867647058823529, 0.5359477124183006]],
                    ],
                },
                "Laser Over Goo": [
                    "images/portal2/chapter2/laser_over_goo/maps/0.png",
                    ["images/portal2/chapter2/laser_over_goo/0.png", [0.09978991596638656, 0.24649859943977592]],
                    ["images/portal2/chapter2/laser_over_goo/1.png", [0.16701680672268907, 0.33239962651727356]],
                    ["images/portal2/chapter2/laser_over_goo/2.png", [0.5609243697478992, 0.2875816993464052]],
                    ["images/portal2/chapter2/laser_over_goo/3.png", [0.648109243697479, 0.33986928104575165]],
                    ["images/portal2/chapter2/laser_over_goo/4.png", [0.8203781512605042, 0.3772175536881419]],
                ],
                "Catapult Intro": [
                    "images/portal2/chapter2/catapult_intro/maps/0.png",
                    ["images/portal2/chapter2/catapult_intro/0.png", [0.26260504201680673, 0.8272642390289449]],
                    ["images/portal2/chapter2/catapult_intro/1.png", [0.7111344537815126, 0.5042016806722689]],
                    ["images/portal2/chapter2/catapult_intro/2.png", [0.7542016806722689, 0.4425770308123249]],
                    ["images/portal2/chapter2/catapult_intro/3.png", [0.41491596638655465, 0.3865546218487395]],
                ],
                "Trust Fling": [
                    "images/portal2/chapter2/trust_fling/maps/0.png",
                    ["images/portal2/chapter2/trust_fling/0.png", [0.2342436974789916, 0.49486461251167135]],
                    ["images/portal2/chapter2/trust_fling/1.png", [0.3960084033613445, 0.7432306255835668]],
                    ["images/portal2/chapter2/trust_fling/2.png", [0.4117647058823529, 0.8011204481792717]],
                    ["images/portal2/chapter2/trust_fling/3.png", [0.680672268907563, 0.30438842203548083]],
                    ["images/portal2/chapter2/trust_fling/4.png", [0.6638655462184874, 0.27450980392156865]],
                ],
                "Pit Flings": [
                    "images/portal2/chapter2/pit_flings/maps/0.png",
                    ["images/portal2/chapter2/pit_flings/0.png", [0.5672268907563025, 0.7469654528478058]],
                    ["images/portal2/chapter2/pit_flings/1.png", [0.6008403361344538, 0.6853408029878618]],
                    ["images/portal2/chapter2/pit_flings/2.png", [0.39915966386554624, 0.5938375350140056]],
                    ["images/portal2/chapter2/pit_flings/3.png", [0.26365546218487396, 0.32679738562091504]],
                ],
                "Fizzler Intro": [
                    "images/portal2/chapter2/fizzler_intro/maps/0.png",
                    ["images/portal2/chapter2/fizzler_intro/0.png", [0.4495798319327731, 0.41643323996265175]],
                    ["images/portal2/chapter2/fizzler_intro/1.png", [0.6596638655462185, 0.646125116713352]],
                    ["images/portal2/chapter2/fizzler_intro/2.png", [0.5262605042016807, 0.49859943977591037]],
                ]
            },
            "Chapter 3 - The Return": {
                "Ceiling Catapult": {
                    "0": [
                        "images/portal2/chapter3/ceiling_catapult/maps/0.png",
                        ["images/portal2/chapter3/ceiling_catapult/0.png", [0.33403361344537813, 0.9785247432306255]],
                        ["images/portal2/chapter3/ceiling_catapult/1.png", [0.6754201680672269, 0.6311858076563959]],
                        ["images/portal2/chapter3/ceiling_catapult/2.png", [0.6207983193277311, 0.20541549953314658]],
                        ["images/portal2/chapter3/ceiling_catapult/3.png", [0.4327731092436975, 0.33613445378151263]],
                    ],
                    "1": [
                        "images/portal2/chapter3/ceiling_catapult/maps/1.png",
                        ["images/portal2/chapter3/ceiling_catapult/4.png", [0.20903361344537816, 0.388422035480859]],
                        ["images/portal2/chapter3/ceiling_catapult/5.png", [0.47794117647058826, 0.8029878618113913]],
                        ["images/portal2/chapter3/ceiling_catapult/6.png", [0.5987394957983193, 0.07096171802054155]],
                        ["images/portal2/chapter3/ceiling_catapult/7.png", [0.7542016806722689, 0.780578898225957]],
                    ],
                },
                "Ricochet": [
                    "images/portal2/chapter3/ricochet/maps/0.png",
                    ["images/portal2/chapter3/ricochet/0.png", [0.6439075630252101, 0.6311858076563959]],
                    ["images/portal2/chapter3/ricochet/1.png", [0.5451680672268907, 0.707749766573296]],
                    ["images/portal2/chapter3/ricochet/2.png", [0.5472689075630253, 0.7880485527544351]],
                    ["images/portal2/chapter3/ricochet/3.png", [0.46008403361344535, 0.48179271708683474]],
                    ["images/portal2/chapter3/ricochet/4.png", [0.3644957983193277, 0.5060690943043884]],
                    ["images/portal2/chapter3/ricochet/5.png", [0.23844537815126052, 0.5266106442577031]],
                ],
                "Bridge Intro": {
                    "0": [
                        "images/portal2/chapter3/bridge_intro/maps/0.png",
                        ["images/portal2/chapter3/bridge_intro/0.png", [0.6186974789915967, 0.40522875816993464]],
                        ["images/portal2/chapter3/bridge_intro/1.png", [0.4569327731092437, 0.8104575163398693]],
                        ["images/portal2/chapter3/bridge_intro/5.png", [0.6502100840336135, 0.5602240896358543]],
                    ],
                    "1": [
                        "images/portal2/chapter3/bridge_intro/maps/1.png",
                        ["images/portal2/chapter3/bridge_intro/2.png", [0.805672268907563, 0.39589169000933705]],
                        ["images/portal2/chapter3/bridge_intro/3.png", [0.6355042016806722, 0.8328664799253035]],
                        ["images/portal2/chapter3/bridge_intro/4.png", [0.45903361344537813, 0.5770308123249299]],
                    ],
                },
                "Bridge The Gap": {
                    "0": [
                        "images/portal2/chapter3/bridge_the_gap/maps/0.png",
                        ["images/portal2/chapter3/bridge_the_gap/0.png", [0.6733193277310925, 0.5751633986928104]],
                        ["images/portal2/chapter3/bridge_the_gap/1.png", [0.20378151260504201, 0.5882352941176471]],
                        ["images/portal2/chapter3/bridge_the_gap/2.png", [0.3392857142857143, 0.5247432306255836]],
                    ],
                    "1": [
                        "images/portal2/chapter3/bridge_the_gap/maps/1.png",
                        ["images/portal2/chapter3/bridge_the_gap/3.png", [0.6995798319327731, 0.7749766573295985]],
                        ["images/portal2/chapter3/bridge_the_gap/4.png", [0.5157563025210085, 0.34547152194211017]],
                    ],
                    "2": [
                        "images/portal2/chapter3/bridge_the_gap/maps/2.png",
                        ["images/portal2/chapter3/bridge_the_gap/5.png", [0.5861344537815126, 0.2726423902894491]],
                        ["images/portal2/chapter3/bridge_the_gap/6.png", [0.34138655462184875, 0.6349206349206349]],
                        ["images/portal2/chapter3/bridge_the_gap/7.png", [0.37184873949579833, 0.5228758169934641]],
                    ],
                },
                "Turret Intro": {
                    "0": [
                        "images/portal2/chapter3/turret_intro/maps/0.png",
                        ["images/portal2/chapter3/turret_intro/0.png", [0.3581932773109244, 0.46872082166199813]],
                        ["images/portal2/chapter3/turret_intro/1.png", [0.49684873949579833, 0.7208216619981326]],
                        ["images/portal2/chapter3/turret_intro/2.png", [0.7815126050420168, 0.1568627450980392]],
                    ],
                    "1": [
                        "images/portal2/chapter3/turret_intro/maps/1.png",
                        ["images/portal2/chapter3/turret_intro/3.png", [0.24369747899159663, 0.3753501400560224]],
                        ["images/portal2/chapter3/turret_intro/4.png", [0.5745798319327731, 0.4780578898225957]],
                    ],
                },
                "Laser Relays": [
                    "images/portal2/chapter3/laser_relays/maps/0.png",
                    ["images/portal2/chapter3/laser_relays/0.png", [0.8865546218487395, 0.5452847805788982]],
                    ["images/portal2/chapter3/laser_relays/1.png", [0.26260504201680673, 0.4444444444444444]],
                    ["images/portal2/chapter3/laser_relays/2.png", [0.3319327731092437, 0.5508870214752568]],
                ],
                "Turret Blocker": [
                    "images/portal2/chapter3/turret_blocker/maps/0.png",
                    ["images/portal2/chapter3/turret_blocker/0.png", [0.7457983193277311, 0.711484593837535]],
                    ["images/portal2/chapter3/turret_blocker/1.png", [0.5619747899159664, 0.3716153127917834]],
                    ["images/portal2/chapter3/turret_blocker/2.png", [0.4254201680672269, 0.33800186741363214]],
                    ["images/portal2/chapter3/turret_blocker/3.png", [0.3319327731092437, 0.40896358543417366]],
                ],
                "Laser VS Turret": {
                    "0": [
                        "images/portal2/chapter3/laser_vs_turret/maps/0.png",
                        ["images/portal2/chapter3/laser_vs_turret/2.png", [0.9926470588235294, 0.8272642390289449]],
                        ["images/portal2/chapter3/laser_vs_turret/3.png", [0.22373949579831934, 0.46872082166199813]],
                    ],
                    "1": [
                        "images/portal2/chapter3/laser_vs_turret/maps/1.png",
                        ["images/portal2/chapter3/laser_vs_turret/0.png", [0.5934873949579832, 0.5284780578898226]],
                        ["images/portal2/chapter3/laser_vs_turret/1.png", [0.5105042016806722, 0.3753501400560224]],
                        ["images/portal2/chapter3/laser_vs_turret/4.png", [0.17542016806722688, 0.5247432306255836]],
                    ],
                },
                "Pull The Rug": [
                    "images/portal2/chapter3/pull_the_rug/maps/0.png",
                    ["images/portal2/chapter3/pull_the_rug/0.png", [0.18592436974789917, 0.49859943977591037]],
                    ["images/portal2/chapter3/pull_the_rug/1.png", [0.2930672268907563, 0.3492063492063492]],
                    ["images/portal2/chapter3/pull_the_rug/2.png", [0.7468487394957983, 0.8179271708683473]],
                ],
            },
        }
    }
}

let gameState = 0; // 0 => choose gamemode
let gameArea = getNestedObject(gameModes, []); // not yet set area to choose locations from

let devMode = 0;
let altDevMode = 0;

gameModeSelector(); // interface to select gameArea

function gameModeSelector() {
    // Create the gameModeSelector div if it doesn't exist
    let gameModeSelector = document.getElementById('gameModeSelector');
    if (!gameModeSelector) {
        gameModeSelector = document.createElement('div');
        gameModeSelector.id = 'gameModeSelector';
        document.body.appendChild(gameModeSelector);
    }

    // Create the selectedPathElement and the selectButton
    const selectedPathElement = document.createElement('p');
    selectedPathElement.id = 'selectedPath';
    selectedPathElement.innerText = 'All Games / ';
    const selectButton = document.createElement('button');
    selectButton.id = 'selectButton';
    selectButton.innerText = 'Select';
    selectButton.onclick = () => {
        selectGameMode();
    };
    gameModeSelector.appendChild(selectedPathElement);
    gameModeSelector.appendChild(selectButton);

    // Helper function to select a game mode
    function selectGameMode() {
        gameState = 1;
        gameModeSelector.remove();
        startGame(gameArea);
    }

    // Helper function to render options
    function renderOptions(options, parentKeys = []) {
        // Clear previous options
        const children = Array.from(gameModeSelector.children);
        children.forEach(child => {
            if (child.id !== 'selectedPath' && child.id !== 'selectButton') {
                gameModeSelector.removeChild(child);
            }
        });

        // Create back button if not at the top level
        if (parentKeys.length > 0) {
            const backButton = document.createElement('button');
            backButton.innerText = 'Back';
            backButton.onclick = () => {
                parentKeys.pop();
                gameArea = getNestedObject(gameModes, parentKeys);
                const selectedPath = parentKeys.join(' > ');
                selectedPathElement.innerText = selectedPath;
                if (parentKeys.length === 0) {
                    selectedPathElement.innerText = 'All Games / ';
                }
                renderOptions(getNestedObject(gameModes, parentKeys), parentKeys);
            };
            gameModeSelector.insertBefore(backButton, selectButton);
        }

        gameModeSelector.appendChild(document.createElement('br'));
        gameModeSelector.appendChild(document.createElement('br'));

        // Render current options
        Object.keys(options).forEach(key => {
            const button = document.createElement('button');
            button.innerText = key;
            const value = options[key];
            if (!(typeof value === 'object' && !Array.isArray(value))) {
                button.style.backgroundColor = 'black';
                button.style.color = 'white';
            }

            button.onclick = () => {
                const selectedPath = parentKeys.concat([key]).join(' > ');
                selectedPathElement.innerText = selectedPath;
                gameArea = getNestedObject(gameModes, parentKeys.concat([key]));
                if (typeof value === 'object' && !Array.isArray(value)) {
                    parentKeys.push(key);
                    renderOptions(value, parentKeys);
                } else {
                    selectGameMode();
                }
            };
            gameModeSelector.appendChild(button);
        });
    }

    // Start rendering options from the top level
    renderOptions(gameModes);
}

// Helper function to navigate the nested object
function getNestedObject(obj, keys) {
    return keys.reduce((o, k) => o && o[k], obj);
}

function startGame(gameArea) {
    let gameContainer = document.getElementById('gameContainer');

    // Create the gameContainer div if it doesn't exist
    if (!gameContainer) {
        gameContainer = document.createElement('div');
        gameContainer.id = 'gameContainer';
        document.body.appendChild(gameContainer);
    }

    gameContainer.innerHTML = '';

    // Display a random image
    function collectLists(obj) {
        let result = [];
        Object.values(obj).forEach(value => {
            if (Array.isArray(value)) {
                result.push(value);
            } else if (typeof value === 'object' && value !== null) {
                result = result.concat(collectLists(value));
            }
        });
        return result;
    }

    const possibleImages = collectLists(gameArea);

    let actualMap = null;

    let [imagePath, solution] = [null, null];

    if (devMode > -1) {
        if (Array.isArray(gameArea)) {
            if (devMode >= gameArea.length) {
                devMode = 0;
            }
            actualMap = gameArea[0];
            [imagePath, solution] = gameArea[1 + devMode];
            devMode++;
        } else {
            if (devMode >= possibleImages.length) {
                devMode = 0;
            }
            if (altDevMode >= possibleImages[devMode].length - 1) {
                altDevMode = 0;
                devMode++;
            }
            const possibleImage = possibleImages[devMode][1 + altDevMode];
            const possibleMaps = possibleImages.find(list => list.includes(possibleImage))
            actualMap = possibleMaps[0];
            [imagePath, solution] = possibleImage;
            altDevMode++;
        }
    } else {
    if (Array.isArray(gameArea)) {
        actualMap = gameArea[0];
        [imagePath, solution] = gameArea[1 + Math.floor(Math.random() * (gameArea.length - 1))];
    } else {
        const randomNumber = Math.floor(Math.random() * possibleImages.length);
            const possibleImage = possibleImages[randomNumber][1 + Math.floor(Math.random() * (possibleImages[randomNumber].length - 1))];
            const possibleMaps = possibleImages.find(list => list.includes(possibleImage))
            actualMap = possibleMaps[0];
        [imagePath, solution] = possibleImage;
        }
    }

    const randomImage = document.createElement('img');
    randomImage.src = imagePath;
    randomImage.style.maxWidth = '100%';
    randomImage.style.height = '50%';
    gameContainer.appendChild(randomImage);
    resize();

    if (devMode > -1) { console.log(`Currently on map ${actualMap} image ${imagePath} with solution ${solution}`); }

    const mapImage = document.createElement('img');

    let selectedMap = null;

    // Create the map selector
    let selection = JSON.parse(JSON.stringify(gameArea));

    const backButton = document.createElement('button');

    const submitButton = document.createElement('button');

    let marker = document.createElement('div');

    const mapSelector = document.createElement('div');
    mapSelector.id = 'mapSelector';
    gameContainer.appendChild(mapSelector);

    const selectedPathElement = document.createElement('p');
    selectedPathElement.id = 'selectedPath';
    selectedPathElement.innerText = 'All Games / ';
    mapSelector.appendChild(selectedPathElement);

    // Helper function to select a map
    function selectMap() {
        gameState = 2;
        mapSelector.style.display = 'none';
        if (devMode > -1) {
            displayMap(actualMap)
        } else {
        displayMap(selection[0]);
        }

        if (!Array.isArray(gameArea)) {
            // Create a back button
            backButton.innerText = 'Back';
            backButton.onclick = () => {
                // Go back to the map selection screen
                gameState = 1;
                mapSelector.style.display = 'block';
                mapImage.style.display = 'none';
                marker.remove();
                submitButton.remove();
                backButton.remove();
            };
            gameContainer.appendChild(backButton);
        }
    }

    // Helper function to render options
    function renderOptions(options, parentKeys = []) {
        // Clear previous options
        const children = Array.from(mapSelector.children);
        children.forEach(child => {
            if (child.id !== 'selectedPath') {
                mapSelector.removeChild(child);
            }
        });

        // Create back button if not at the top level
        if (parentKeys.length > 0) {
            const backButton = document.createElement('button');
            backButton.innerText = 'Back';
            backButton.onclick = () => {
                parentKeys.pop();
                selection = getNestedObject(gameModes, parentKeys);
                const selectedPath = parentKeys.join(' > ');
                selectedPathElement.innerText = selectedPath;
                if (parentKeys.length === 0) {
                    selectedPathElement.innerText = 'All Games / ';
                }
                renderOptions(getNestedObject(gameModes, parentKeys), parentKeys);
            };
            mapSelector.appendChild(backButton);
        }

        mapSelector.appendChild(document.createElement('br'));
        mapSelector.appendChild(document.createElement('br'));

        // Render current options
        Object.keys(options).forEach(key => {
            const button = document.createElement('button');
            button.innerText = key;
            const value = options[key];
            if (!(typeof value === 'object' && !Array.isArray(value))) {
                button.style.backgroundColor = 'black';
                button.style.color = 'white';
            }

            button.onclick = () => {
                const selectedPath = parentKeys.concat([key]).join(' > ');
                selectedPathElement.innerText = selectedPath;
                const newSelected = getNestedObject(gameModes, parentKeys.concat([key]));
                if (!newSelected) {
                    selection = selection[key];
                } else {
                    selection = newSelected;
                }
                if (typeof value === 'object' && !Array.isArray(value)) {
                    parentKeys.push(key);
                    renderOptions(value, parentKeys);
                } else {
                    selectMap();
                }
            };
            mapSelector.appendChild(button);
        });
    }

    // Start rendering options from the top level
    if (Array.isArray(selection) || devMode > -1) {
        selectMap();
    } else {
        renderOptions(selection);
    }

    function displayMap(map) {
        // Display the map image
        selectedMap = map
        mapImage.src = map;
        mapImage.style.maxWidth = '100%';
        mapImage.style.height = '50%';
        gameContainer.appendChild(mapImage);
        resize();

        // Create a marker on the map
        marker.style.position = 'absolute';
        marker.style.width = '10px';
        marker.style.height = '10px';
        marker.style.backgroundColor = 'red';
        marker.style.borderRadius = '50%';
        marker.style.display = 'none'; // Initially hidden
        document.body.appendChild(marker);

        // Listen for map clicks to place marker
        mapImage.onclick = (event) => {
            if (document.body.contains(submitButton)) {
                const rect = mapImage.getBoundingClientRect();
                const x = ((event.clientX - rect.left) + window.scrollX) / rect.width;
                const y = ((event.clientY - rect.top) + window.scrollY) / rect.height;
                marker.style.left = `${event.pageX - 5}px`; // subtract half the size of the marker
                marker.style.top = `${event.pageY - 5}px`;
                marker.style.display = 'block';
                marker.dataset.x = x;
                marker.dataset.y = y;
                console.log(`${x}, ${y}`);
            }
        };

        // Create submit button
        submitButton.innerText = 'Submit';
        submitButton.onclick = () => {
            if (marker.style.display === 'block') {
                backButton.remove();
                gameContainer.appendChild(continueButton);
                if (selectedMap === actualMap) {
                    const userX = parseFloat(marker.dataset.x);
                    const userY = parseFloat(marker.dataset.y);
                    const [solutionX, solutionY] = solution;
                    const distance = Math.sqrt(Math.pow(userX - solutionX, 2) + Math.pow(userY - solutionY, 2));
                    const score = Math.max(0, 1000 - distance * 1000);

                    if (Array.isArray(solution) && solution.length > 0) {
                        alert(`You scored ${score.toFixed(0)} points!`);
                        const solutionMarker = document.createElement('div');
                        solutionMarker.style.position = 'absolute';
                        solutionMarker.style.width = '10px';
                        solutionMarker.style.height = '10px';
                        solutionMarker.style.backgroundColor = 'green';
                        solutionMarker.style.borderRadius = '50%';
                        solutionMarker.style.left = `${mapImage.offsetLeft + solutionX * mapImage.offsetWidth - 5}px`; // subtract half the size of the marker
                        solutionMarker.style.top = `${mapImage.offsetTop + solutionY * mapImage.offsetHeight - 5}px`;
                        document.body.appendChild(solutionMarker);
                    } else {
                        alert('You got the map correct!\nThis image has not been assigned a solution yet.');
                    }
                } else {
                    const pathToMap = actualMap.split('/').slice(1, -2).join(' > ');
                    alert('You have chosen the wrong map. It was ' + pathToMap);
                }

                submitButton.remove();
            } else {
                alert('Please place a marker on the map');
            }
        };

        const breakElements = gameContainer.querySelectorAll('br');
        if (breakElements.length === 0) {
            gameContainer.appendChild(document.createElement('br'));
        }
        gameContainer.appendChild(submitButton);

        if (devMode > -1) { console.log(`Currently on map ${actualMap} (image ${imagePath.split('/').slice(-1).join(' > ')}), which you think is ${selectedMap}`); }
        mapImage.style.display = '';

        // Create continue button
        const continueButton = document.createElement('button');
        continueButton.innerText = 'Continue';
        continueButton.onclick = () => {
            marker.remove();
            startGame(gameArea); // Restart game with current area
        };
    }
}

function resize() {
    const allImages = document.querySelectorAll('img');

    const width = window.innerWidth;
    const height = window.innerHeight;
    const isPortrait = (width < height) || (allImages.length === 1);
    const imageWidth = isPortrait ? '100%' : '50%';

    allImages.forEach(img => img.style.width = imageWidth);
}

window.addEventListener('resize', resize);
