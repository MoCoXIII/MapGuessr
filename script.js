const gameModes = {
    "Portal Series": {
        "Portal 2": {
            "Chapter 1 - The Courtesy Call": {
                "Container Ride": {
                    "Intact Room": [
                        "images/portal2/chapter1/container_ride/maps/intact_room.png",
                        ["images/portal2/chapter1/container_ride/0.png", []],
                    ],
                    "Broken Room": [
                        "images/portal2/chapter1/container_ride/maps/broken_room.png",
                        ["images/portal2/chapter1/container_ride/1.png", []],
                        ["images/portal2/chapter1/container_ride/2.png", []],
                        ["images/portal2/chapter1/container_ride/3.png", []],
                    ],
                    "Container Ride": [
                        "images/portal2/chapter1/container_ride/maps/container_ride.png",
                        ["images/portal2/chapter1/container_ride/4.png", []],
                        ["images/portal2/chapter1/container_ride/5.png", []],
                    ],
                    "Puzzle": [
                        "images/portal2/chapter1/container_ride/maps/puzzle.png",
                        ["images/portal2/chapter1/container_ride/6.png", []],
                        ["images/portal2/chapter1/container_ride/7.png", []],
                        ["images/portal2/chapter1/container_ride/8.png", []],
                    ],
                },
                "Portal Carousel": [
                    "images/portal2/chapter1/portal_carousel/maps/0.png",
                    ["images/portal2/chapter1/portal_carousel/0.png", []],
                    ["images/portal2/chapter1/portal_carousel/1.png", []],
                ],
                "Portal Gun": {
                    "0": [
                        "images/portal2/chapter1/portal_gun/maps/0.png",
                        ["images/portal2/chapter1/portal_gun/0.png", []],
                        ["images/portal2/chapter1/portal_gun/1.png", []],
                        ["images/portal2/chapter1/portal_gun/2.png", []],
                    ],
                    "1": [
                        "images/portal2/chapter1/portal_gun/maps/1.png",
                        ["images/portal2/chapter1/portal_gun/3.png", []],
                        ["images/portal2/chapter1/portal_gun/4.png", []],
                    ],
                    "2": [
                        "images/portal2/chapter1/portal_gun/maps/2.png",
                        ["images/portal2/chapter1/portal_gun/5.png", []],
                    ],
                    "3": [
                        "images/portal2/chapter1/portal_gun/maps/3.png",
                        ["images/portal2/chapter1/portal_gun/6.png", []],
                        ["images/portal2/chapter1/portal_gun/7.png", []],
                        ["images/portal2/chapter1/portal_gun/8.png", []],
                    ],
                },
                "Smooth Jazz": {
                    "0": [
                        "images/portal2/chapter1/smooth_jazz/maps/0.png",
                        ["images/portal2/chapter1/smooth_jazz/0.png", []],
                        ["images/portal2/chapter1/smooth_jazz/1.png", []],
                    ],
                    "1": [
                        "images/portal2/chapter1/smooth_jazz/maps/1.png",
                        ["images/portal2/chapter1/smooth_jazz/2.png", []],
                        ["images/portal2/chapter1/smooth_jazz/3.png", []],
                    ],
                },
                "Cube Momentum": [
                    "images/portal2/chapter1/cube_momentum/maps/0.png",
                    ["images/portal2/chapter1/cube_momentum/0.png", []],
                    ["images/portal2/chapter1/cube_momentum/1.png", []],
                    ["images/portal2/chapter1/cube_momentum/2.png", []],
                ],
                "Future Starter": {
                    "0": [
                        "images/portal2/chapter1/future_starter/maps/0.png",
                        ["images/portal2/chapter1/future_starter/0.png", []],
                        ["images/portal2/chapter1/future_starter/1.png", []],
                        ["images/portal2/chapter1/future_starter/2.png", []],
                    ],
                    "1": [
                        "images/portal2/chapter1/future_starter/maps/1.png",
                        ["images/portal2/chapter1/future_starter/3.png", []],
                        ["images/portal2/chapter1/future_starter/4.png", []],
                        ["images/portal2/chapter1/future_starter/5.png", []],
                    ],
                },
                "Secret Panel": {
                    "0": [
                        "images/portal2/chapter1/secret_panel/maps/0.png",
                        ["images/portal2/chapter1/secret_panel/0.png", []],
                        ["images/portal2/chapter1/secret_panel/1.png", []],
                        ["images/portal2/chapter1/secret_panel/3.png", []],
                        ["images/portal2/chapter1/secret_panel/4.png", []],
                    ],
                    "1": [
                        "images/portal2/chapter1/secret_panel/maps/1.png",
                        ["images/portal2/chapter1/secret_panel/2.png", []],
                    ]
                },
                "Wake Up": {
                    "0": [
                        "images/portal2/chapter1/wake_up/maps/0.png",
                        ["images/portal2/chapter1/wake_up/0.png", []],
                        ["images/portal2/chapter1/wake_up/1.png", []],
                        ["images/portal2/chapter1/wake_up/2.png", []],
                        ["images/portal2/chapter1/wake_up/4.png", []],
                        ["images/portal2/chapter1/wake_up/5.png", []],
                    ],
                    "1": [
                        "images/portal2/chapter1/wake_up/maps/1.png",
                        ["images/portal2/chapter1/wake_up/3.png", []],
                    ]
                },
                "Incinerator": {
                    "0": [
                        "images/portal2/chapter1/incinerator/maps/0.png",
                        ["images/portal2/chapter1/incinerator/0.png", []],
                    ],
                    "1": [
                        "images/portal2/chapter1/incinerator/maps/1.png",
                        ["images/portal2/chapter1/incinerator/1.png", []],

                    ],
                    "2": [
                        "images/portal2/chapter1/incinerator/maps/2.png",
                        ["images/portal2/chapter1/incinerator/2.png", []],
                        ["images/portal2/chapter1/incinerator/3.png", []],
                        ["images/portal2/chapter1/incinerator/4.png", []],
                    ],
                }
            },
            "Chapter 2 - The Cold Boot": {
                "Laser Intro": [
                    "images/portal2/chapter2/laser_intro/maps/0.png",
                    ["images/portal2/chapter2/laser_intro/0.png", []],
                    ["images/portal2/chapter2/laser_intro/1.png", []],
                    ["images/portal2/chapter2/laser_intro/2.png", []],
                ],
                "Laser Stairs": [
                    "images/portal2/chapter2/laser_stairs/maps/0.png",
                    ["images/portal2/chapter2/laser_stairs/0.png", []],
                    ["images/portal2/chapter2/laser_stairs/1.png", []],
                    ["images/portal2/chapter2/laser_stairs/2.png", []],
                    ["images/portal2/chapter2/laser_stairs/3.png", []],
                ],
                "Dual Lasers": {
                    "0": [
                        "images/portal2/chapter2/dual_lasers/maps/0.png",
                        ["images/portal2/chapter2/dual_lasers/1.png", []],
                        ["images/portal2/chapter2/dual_lasers/2.png", []],
                    ],
                    "1": [
                        "images/portal2/chapter2/dual_lasers/maps/1.png",
                        ["images/portal2/chapter2/dual_lasers/0.png", []],
                        ["images/portal2/chapter2/dual_lasers/3.png", []],
                        ["images/portal2/chapter2/dual_lasers/4.png", []],
                    ],
                },
                "Laser Over Goo": [
                    "images/portal2/chapter2/laser_over_goo/maps/0.png",
                    ["images/portal2/chapter2/laser_over_goo/0.png", []],
                    ["images/portal2/chapter2/laser_over_goo/1.png", []],
                    ["images/portal2/chapter2/laser_over_goo/2.png", []],
                    ["images/portal2/chapter2/laser_over_goo/3.png", []],
                    ["images/portal2/chapter2/laser_over_goo/4.png", []],
                ],
                "Catapult Intro": [
                    "images/portal2/chapter2/catapult_intro/maps/0.png",
                    ["images/portal2/chapter2/catapult_intro/0.png", []],
                    ["images/portal2/chapter2/catapult_intro/1.png", []],
                    ["images/portal2/chapter2/catapult_intro/2.png", []],
                    ["images/portal2/chapter2/catapult_intro/3.png", []],
                ],
                "Trust Fling": [
                    "images/portal2/chapter2/trust_fling/maps/0.png",
                    ["images/portal2/chapter2/trust_fling/0.png", []],
                    ["images/portal2/chapter2/trust_fling/1.png", []],
                    ["images/portal2/chapter2/trust_fling/2.png", []],
                    ["images/portal2/chapter2/trust_fling/3.png", []],
                    ["images/portal2/chapter2/trust_fling/4.png", []],
                ],
                "Pit Flings": [
                    "images/portal2/chapter2/pit_flings/maps/0.png",
                    ["images/portal2/chapter2/pit_flings/0.png", []],
                    ["images/portal2/chapter2/pit_flings/1.png", []],
                    ["images/portal2/chapter2/pit_flings/2.png", []],
                    ["images/portal2/chapter2/pit_flings/3.png", []],
                ],
                "Fizzler Intro": [
                    "images/portal2/chapter2/fizzler_intro/maps/0.png",
                    ["images/portal2/chapter2/fizzler_intro/0.png", []],
                    ["images/portal2/chapter2/fizzler_intro/1.png", []],
                    ["images/portal2/chapter2/fizzler_intro/2.png", []],
                ]
            }
        }
    }
}

let gameState = 0; // 0 => choose gamemode
let gameArea = getNestedObject(gameModes, []); // not yet set area to choose locations from

gameModeSelector(); // interface to select gameArea

function gameModeSelector() {
    // Create the gameModeSelector div if it doesn't exist
    let gameModeSelector = document.getElementById('gameModeSelector');
    if (!gameModeSelector) {
        gameModeSelector = document.createElement('div');
        gameModeSelector.id = 'gameModeSelector';
        document.body.appendChild(gameModeSelector);
    }

    // Create the selectedPathElement and the selectButton
    const selectedPathElement = document.createElement('p');
    selectedPathElement.id = 'selectedPath';
    selectedPathElement.innerText = 'All Games / ';
    const selectButton = document.createElement('button');
    selectButton.id = 'selectButton';
    selectButton.innerText = 'Select';
    selectButton.onclick = () => {
        selectGameMode();
    };
    gameModeSelector.appendChild(selectedPathElement);
    gameModeSelector.appendChild(selectButton);

    // Helper function to select a game mode
    function selectGameMode() {
        gameState = 1;
        gameModeSelector.remove();
        startGame(gameArea);
    }

    // Helper function to render options
    function renderOptions(options, parentKeys = []) {
        // Clear previous options
        const children = Array.from(gameModeSelector.children);
        children.forEach(child => {
            if (child.id !== 'selectedPath' && child.id !== 'selectButton') {
                gameModeSelector.removeChild(child);
            }
        });

        // Create back button if not at the top level
        if (parentKeys.length > 0) {
            const backButton = document.createElement('button');
            backButton.innerText = 'Back';
            backButton.onclick = () => {
                parentKeys.pop();
                gameArea = getNestedObject(gameModes, parentKeys);
                const selectedPath = parentKeys.join(' > ');
                selectedPathElement.innerText = selectedPath;
                if (parentKeys.length === 0) {
                    selectedPathElement.innerText = 'All Games / ';
                }
                renderOptions(getNestedObject(gameModes, parentKeys), parentKeys);
            };
            gameModeSelector.insertBefore(backButton, selectButton);
        }

        gameModeSelector.appendChild(document.createElement('br'));
        gameModeSelector.appendChild(document.createElement('br'));

        // Render current options
        Object.keys(options).forEach(key => {
            const button = document.createElement('button');
            button.innerText = key;
            const value = options[key];
            if (!(typeof value === 'object' && !Array.isArray(value))) {
                button.style.backgroundColor = 'black';
                button.style.color = 'white';
            }

            button.onclick = () => {
                const selectedPath = parentKeys.concat([key]).join(' > ');
                selectedPathElement.innerText = selectedPath;
                gameArea = getNestedObject(gameModes, parentKeys.concat([key]));
                if (typeof value === 'object' && !Array.isArray(value)) {
                    parentKeys.push(key);
                    renderOptions(value, parentKeys);
                } else {
                    selectGameMode();
                }
            };
            gameModeSelector.appendChild(button);
        });
    }

    // Start rendering options from the top level
    renderOptions(gameModes);
}

// Helper function to navigate the nested object
function getNestedObject(obj, keys) {
    return keys.reduce((o, k) => o && o[k], obj);
}

function startGame(gameArea) {
    let gameContainer = document.getElementById('gameContainer');

    // Create the gameContainer div if it doesn't exist
    if (!gameContainer) {
        gameContainer = document.createElement('div');
        gameContainer.id = 'gameContainer';
        document.body.appendChild(gameContainer);
    }

    gameContainer.innerHTML = '';

    // Display a random image
    function collectLists(obj) {
        let result = [];
        Object.values(obj).forEach(value => {
            if (Array.isArray(value)) {
                result.push(value);
            } else if (typeof value === 'object' && value !== null) {
                result = result.concat(collectLists(value));
            }
        });
        return result;
    }

    const possibleImages = collectLists(gameArea);

    let actualMap = null;

    let [imagePath, solution] = [null, null];

    if (Array.isArray(gameArea)) {
        actualMap = gameArea[0];
        [imagePath, solution] = gameArea[1 + Math.floor(Math.random() * (gameArea.length - 1))];
    } else {
        const randomNumber = Math.floor(Math.random() * possibleImages.length);
        const possibleImage = possibleImages[randomNumber][1 + Math.floor(Math.random() * possibleImages[randomNumber].length)];
        actualMap = possibleImages.find(list => list.includes(possibleImage))[0];
        [imagePath, solution] = possibleImage;
    }

    const randomImage = document.createElement('img');
    randomImage.src = imagePath;
    randomImage.style.maxWidth = '100%';
    randomImage.style.height = '50%';
    gameContainer.appendChild(randomImage);
    resize();

    const mapImage = document.createElement('img');

    let selectedMap = null;

    // Create the map selector
    let selection = JSON.parse(JSON.stringify(gameArea));

    const backButton = document.createElement('button');

    const submitButton = document.createElement('button');

    const mapSelector = document.createElement('div');
    mapSelector.id = 'mapSelector';
    gameContainer.appendChild(mapSelector);

    const selectedPathElement = document.createElement('p');
    selectedPathElement.id = 'selectedPath';
    selectedPathElement.innerText = 'All Games / ';
    mapSelector.appendChild(selectedPathElement);

    // Helper function to select a map
    function selectMap() {
        gameState = 2;
        mapSelector.style.display = 'none';
        displayMap(selection[0]);

        if (!Array.isArray(gameArea)) {
            // Create a back button
            backButton.innerText = 'Back';
            backButton.onclick = () => {
                // Go back to the map selection screen
                gameState = 1;
                mapSelector.style.display = 'block';
                mapImage.style.display = 'none';
                submitButton.remove();
                backButton.remove();
            };
            gameContainer.appendChild(backButton);
        }
    }

    // Helper function to render options
    function renderOptions(options, parentKeys = []) {
        // Clear previous options
        const children = Array.from(mapSelector.children);
        children.forEach(child => {
            if (child.id !== 'selectedPath') {
                mapSelector.removeChild(child);
            }
        });

        // Create back button if not at the top level
        if (parentKeys.length > 0) {
            const backButton = document.createElement('button');
            backButton.innerText = 'Back';
            backButton.onclick = () => {
                parentKeys.pop();
                selection = getNestedObject(gameModes, parentKeys);
                const selectedPath = parentKeys.join(' > ');
                selectedPathElement.innerText = selectedPath;
                if (parentKeys.length === 0) {
                    selectedPathElement.innerText = 'All Games / ';
                }
                renderOptions(getNestedObject(gameModes, parentKeys), parentKeys);
            };
            mapSelector.appendChild(backButton);
        }

        mapSelector.appendChild(document.createElement('br'));
        mapSelector.appendChild(document.createElement('br'));

        // Render current options
        Object.keys(options).forEach(key => {
            const button = document.createElement('button');
            button.innerText = key;
            const value = options[key];
            if (!(typeof value === 'object' && !Array.isArray(value))) {
                button.style.backgroundColor = 'black';
                button.style.color = 'white';
            }

            button.onclick = () => {
                const selectedPath = parentKeys.concat([key]).join(' > ');
                selectedPathElement.innerText = selectedPath;
                const newSelected = getNestedObject(gameModes, parentKeys.concat([key]));
                if (!newSelected) {
                    selection = selection[key];
                } else {
                    selection = newSelected;
                }
                if (typeof value === 'object' && !Array.isArray(value)) {
                    parentKeys.push(key);
                    renderOptions(value, parentKeys);
                } else {
                    selectMap();
                }
            };
            mapSelector.appendChild(button);
        });
    }

    // Start rendering options from the top level
    if (Array.isArray(selection)) {
        selectMap();
    } else {
        renderOptions(selection);
    }

    function displayMap(map) {
        // Display the map image
        selectedMap = map
        mapImage.src = map;
        mapImage.style.maxWidth = '100%';
        mapImage.style.height = '50%';
        gameContainer.appendChild(mapImage);
        resize();

        // Create a marker on the map
        let marker = document.createElement('div');
        marker.style.position = 'absolute';
        marker.style.width = '10px';
        marker.style.height = '10px';
        marker.style.backgroundColor = 'red';
        marker.style.borderRadius = '50%';
        marker.style.display = 'none'; // Initially hidden
        document.body.appendChild(marker);

        // Listen for map clicks to place marker
        mapImage.onclick = (event) => {
            if (document.body.contains(submitButton)) {
                const rect = mapImage.getBoundingClientRect();
                const x = ((event.clientX - rect.left) + window.scrollX) / rect.width;
                const y = ((event.clientY - rect.top) + window.scrollY) / rect.height;
                marker.style.left = `${event.pageX - 5}px`; // subtract half the size of the marker
                marker.style.top = `${event.pageY - 5}px`;
                marker.style.display = 'block';
                marker.dataset.x = x;
                marker.dataset.y = y;
                console.log(x, y);
            }
        };

        // Create submit button
        submitButton.innerText = 'Submit';
        submitButton.onclick = () => {
            if (marker.style.display === 'block') {
                backButton.remove();
                gameContainer.appendChild(continueButton);
                if (selectedMap === actualMap) {
                    const userX = parseFloat(marker.dataset.x);
                    const userY = parseFloat(marker.dataset.y);
                    const [solutionX, solutionY] = solution;
                    const distance = Math.sqrt(Math.pow(userX - solutionX, 2) + Math.pow(userY - solutionY, 2));
                    const score = Math.max(0, 1000 - distance * 1000);

                    if (Array.isArray(solution) && solution.length > 0) {
                        alert(`You scored ${score.toFixed(0)} points!`);
                        const solutionMarker = document.createElement('div');
                        solutionMarker.style.position = 'absolute';
                        solutionMarker.style.width = '10px';
                        solutionMarker.style.height = '10px';
                        solutionMarker.style.backgroundColor = 'green';
                        solutionMarker.style.borderRadius = '50%';
                        solutionMarker.style.left = `${mapImage.offsetLeft + solutionX * mapImage.offsetWidth - 5}px`; // subtract half the size of the marker
                        solutionMarker.style.top = `${mapImage.offsetTop + solutionY * mapImage.offsetHeight - 5}px`;
                        document.body.appendChild(solutionMarker);
                    } else {
                        alert('You got the map correct!\nThis image has not been assigned a solution yet.');
                    }
                } else {
                    const pathToMap = actualMap.split('/').slice(1, -2).join(' > ');
                    alert('You have chosen the wrong map. It was ' + pathToMap);
                }

                submitButton.remove();
            } else {
                alert('Please place a marker on the map');
            }
        };
        gameContainer.appendChild(document.createElement('br'));
        gameContainer.appendChild(submitButton);

        console.log(`Currently on map ${actualMap}, which you think is ${selectedMap}`);

        // Create continue button
        const continueButton = document.createElement('button');
        continueButton.innerText = 'Continue';
        continueButton.onclick = () => {
            marker.remove();
            startGame(gameArea); // Restart game with current area
        };
    }
}

function resize() {
    const allImages = document.querySelectorAll('img');

    const width = window.innerWidth;
    const height = window.innerHeight;
    const isPortrait = (width < height) || (allImages.length === 1);
    const imageWidth = isPortrait ? '100%' : '50%';

    allImages.forEach(img => img.style.width = imageWidth);
}

window.addEventListener('resize', resize);
